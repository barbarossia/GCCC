# ç”¨æˆ·ä»ªè¡¨ç›˜æ¨¡å—è¯¦ç»†è®¾è®¡æ–‡æ¡£

## 1. æ¨¡å—æ¦‚è¿°

ç”¨æˆ·ä»ªè¡¨ç›˜æ˜¯ç”¨æˆ·çš„ä¸ªäººèµ„äº§ç®¡ç†ä¸­å¿ƒï¼Œæä¾›å…¨é¢çš„èµ„äº§æ¦‚è§ˆå’Œå…³é”®æ“ä½œå…¥å£ã€‚ç”¨æˆ·å¯ä»¥åœ¨æ­¤æŸ¥çœ‹æ‰€æœ‰æŒæœ‰çš„èµ„äº§ï¼ŒåŒ…æ‹¬ SOLã€GCCC Tokenã€Pointsã€çºªå¿µå¸ NFT å’Œç¢ç‰‡ Tokenã€‚è¯¥æ¨¡å—ä¸ç”¨æˆ·ç®¡ç†ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæä¾›ä¸ªæ€§åŒ–çš„ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨çš„èº«ä»½éªŒè¯ã€‚

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 æ ¸å¿ƒåŠŸèƒ½
- **ç”¨æˆ·èº«ä»½å±•ç¤º**: æ˜¾ç¤ºç”¨æˆ·å¤´åƒã€ç”¨æˆ·åã€ç­‰çº§ç­‰ä¿¡æ¯
- **èµ„äº§æ¦‚è§ˆ**: å±•ç¤ºç”¨æˆ·æ‰€æœ‰æ•°å­—èµ„äº§çš„å®æ—¶ä½™é¢
- **èµ„äº§è¯¦æƒ…**: ç‚¹å‡»æŸ¥çœ‹å„ç±»èµ„äº§çš„è¯¦ç»†ä¿¡æ¯
- **å¿«é€Ÿæ“ä½œ**: æä¾›å¸¸ç”¨æ“ä½œçš„å¿«æ·å…¥å£
- **äº¤æ˜“å†å²**: æ˜¾ç¤ºæœ€è¿‘çš„äº¤æ˜“è®°å½•
- **æ•°æ®åˆ·æ–°**: å®æ—¶æˆ–æ‰‹åŠ¨åˆ·æ–°èµ„äº§æ•°æ®
- **èµ„äº§ç»Ÿè®¡**: æ˜¾ç¤ºèµ„äº§çš„ä»·å€¼ç»Ÿè®¡å’Œè¶‹åŠ¿
- **ä¸ªäººèµ„æ–™ç®¡ç†**: å¿«é€Ÿè®¿é—®ä¸ªäººèµ„æ–™è®¾ç½®
- **æ¨èç³»ç»Ÿ**: å±•ç¤ºæ¨èç å’Œé‚€è¯·å¥–åŠ±

### 2.2 å±•ç¤ºå†…å®¹
- **SOL ä½™é¢**: ä¸»ç½‘ç»œä»£å¸ä½™é¢
- **GCCC Token**: æ²»ç†ä»£å¸æ•°é‡å’Œè´¨æŠ¼çŠ¶æ€
- **Points**: ç§¯åˆ†ä½™é¢å’Œè·å–å†å²
- **çºªå¿µå¸ NFT**: æŒæœ‰çš„å„ç­‰çº§çºªå¿µå¸
- **ç¢ç‰‡ Token**: å¯ç”¨äºåˆæˆçš„ç¢ç‰‡æ•°é‡

## 3. æŠ€æœ¯å®ç°

### 3.1 æŠ€æœ¯æ ˆ
```javascript
{
  "@solana/web3.js": "^1.95.2",
  "@solana/spl-token": "^0.4.6",
  "@metaplex-foundation/js": "^0.20.1",
  "recharts": "^2.12.7",
  "react-query": "^3.39.3",
  "axios": "^1.7.2"
}
```

### 3.2 ç»„ä»¶æ¶æ„
```
UserDashboard
â”œâ”€â”€ UserProfile (ç”¨æˆ·ä¿¡æ¯å¡ç‰‡)
â”œâ”€â”€ AssetSummary (èµ„äº§æ€»è§ˆ)
â”œâ”€â”€ SOLBalance (SOLä½™é¢å¡ç‰‡)
â”œâ”€â”€ GCCCBalance (GCCCä½™é¢å¡ç‰‡)
â”œâ”€â”€ PointsBalance (ç§¯åˆ†ä½™é¢å¡ç‰‡)
â”œâ”€â”€ NFTCollection (çºªå¿µå¸æ”¶è—)
â”œâ”€â”€ FragmentBalance (ç¢ç‰‡ä½™é¢å¡ç‰‡)
â”œâ”€â”€ TransactionHistory (äº¤æ˜“å†å²)
â”œâ”€â”€ QuickActions (å¿«é€Ÿæ“ä½œ)
â”œâ”€â”€ AssetChart (èµ„äº§è¶‹åŠ¿å›¾)
â”œâ”€â”€ ReferralCard (æ¨èå¡ç‰‡)
â””â”€â”€ AuthGuard (è®¤è¯å®ˆå«)
```

### 3.3 æ ¸å¿ƒä»£ç ç»“æ„

#### 3.3.1 ä¸»ä»ªè¡¨ç›˜ç»„ä»¶
```typescript
// components/dashboard/UserDashboard.tsx
import React, { useState, useEffect } from 'react';
import { useWallet } from '@solana/wallet-adapter-react';
import { useAuth } from '../../contexts/AuthContext';
import { useAssetData } from '../../hooks/useAssetData';
import { UserProfile } from './UserProfile';
import { AssetSummary } from './AssetSummary';
import { SOLBalance } from './SOLBalance';
import { GCCCBalance } from './GCCCBalance';
import { PointsBalance } from './PointsBalance';
import { NFTCollection } from './NFTCollection';
import { FragmentBalance } from './FragmentBalance';
import { TransactionHistory } from './TransactionHistory';
import { QuickActions } from './QuickActions';
import { ReferralCard } from './ReferralCard';
import { AuthGuard } from '../auth/AuthGuard';

export const UserDashboard: React.FC = () => {
  const { publicKey, connected } = useWallet();
  const { state: authState } = useAuth();
  const { 
    assetData, 
    loading, 
    error, 
    refetch 
  } = useAssetData(publicKey);

  return (
    <AuthGuard requireAuth={true}>
      <div className="user-dashboard">
        {/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */}
        <div className="dashboard-header">
          <UserProfile user={authState.user} />
          <AssetSummary data={assetData} />
        </div>
        
        {/* èµ„äº§å¡ç‰‡ç½‘æ ¼ */}
        <div className="asset-grid">
          <SOLBalance balance={assetData.sol} />
          <GCCCBalance 
            balance={assetData.gccc} 
            staked={assetData.gccStaked}
          />
          <PointsBalance 
            balance={assetData.points}
            dailyEarned={assetData.dailyPoints}
          />
          <FragmentBalance balance={assetData.fragments} />
        </div>

        {/* NFT æ”¶è—å±•ç¤º */}
        <NFTCollection nfts={assetData.nfts} />

        {/* æ¨èç³»ç»Ÿ */}
        <ReferralCard user={authState.user} />

        {/* åº•éƒ¨åŒºåŸŸ */}
        <div className="dashboard-bottom">
          <QuickActions />
          <TransactionHistory 
            publicKey={publicKey} 
            limit={10} 
          />
        </div>
      </div>
    </AuthGuard>
  );
};
```

#### 3.3.2 ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ç»„ä»¶
```typescript
// components/dashboard/UserProfile.tsx
import React, { useState } from 'react';
import { User } from '../../types/user';
import { motion } from 'framer-motion';

interface UserProfileProps {
  user: User | null;
}

export const UserProfile: React.FC<UserProfileProps> = ({ user }) => {
  const [showProfileMenu, setShowProfileMenu] = useState(false);

  if (!user) return null;

  const getVipBadgeColor = (level: string) => {
    switch (level) {
      case 'diamond': return '#b9f2ff';
      case 'gold': return '#ffd700';
      case 'silver': return '#c0c0c0';
      default: return '#8b9dc3';
    }
  };

  return (
    <div className="user-profile-card">
      <div className="profile-main">
        {/* ç”¨æˆ·å¤´åƒ */}
        <div className="user-avatar-container">
          <div className="user-avatar">
            {user.avatar ? (
              <img src={user.avatar} alt={user.username} />
            ) : (
              <div className="default-avatar">
                {user.username?.[0]?.toUpperCase() || 'U'}
              </div>
            )}
          </div>
          
          {/* VIPç­‰çº§å¾½ç«  */}
          <div 
            className="vip-badge"
            style={{ backgroundColor: getVipBadgeColor(user.vipLevel) }}
          >
            {user.vipLevel.toUpperCase()}
          </div>
        </div>

        {/* ç”¨æˆ·ä¿¡æ¯ */}
        <div className="user-info">
          <div className="username-section">
            <h2 className="username">{user.username}</h2>
            {user.kycStatus === 'verified' && (
              <span className="verified-badge" title="å·²è®¤è¯ç”¨æˆ·">
                âœ…
              </span>
            )}
          </div>
          
          <div className="user-stats">
            <div className="stat-item">
              <span className="stat-label">ç­‰çº§</span>
              <span className="stat-value">{user.level}</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">ç§¯åˆ†</span>
              <span className="stat-value">{user.points.toLocaleString()}</span>
            </div>
            <div className="stat-item">
              <span className="stat-label">æ¨èç </span>
              <span className="stat-value referral-code">{user.referralCode}</span>
            </div>
          </div>
        </div>

        {/* å¿«é€Ÿæ“ä½œ */}
        <div className="profile-actions">
          <button 
            className="profile-menu-btn"
            onClick={() => setShowProfileMenu(!showProfileMenu)}
          >
            âš™ï¸
          </button>
          
          {showProfileMenu && (
            <motion.div
              className="profile-menu"
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
            >
              <button className="menu-item">
                ğŸ“ ç¼–è¾‘èµ„æ–™
              </button>
              <button className="menu-item">
                ğŸ”’ å®‰å…¨è®¾ç½®
              </button>
              <button className="menu-item">
                ğŸ“Š æ•°æ®ç»Ÿè®¡
              </button>
              <hr />
              <button className="menu-item logout">
                ğŸšª é€€å‡ºç™»å½•
              </button>
            </motion.div>
          )}
        </div>
      </div>

      {/* è¿›åº¦æ¡æ˜¾ç¤ºç»éªŒå€¼ */}
      <div className="level-progress">
        <div className="progress-info">
          <span>ç»éªŒå€¼</span>
          <span>{user.points} / {(user.level + 1) * 1000}</span>
        </div>
        <div className="progress-bar">
          <motion.div
            className="progress-fill"
            initial={{ width: 0 }}
            animate={{ 
              width: `${Math.min((user.points % 1000) / 10, 100)}%` 
            }}
            transition={{ duration: 1 }}
          />
        </div>
      </div>
    </div>
  );
};
```

#### 3.3.3 æ¨èå¡ç‰‡ç»„ä»¶
```typescript
// components/dashboard/ReferralCard.tsx
import React, { useState } from 'react';
import { User } from '../../types/user';
import { motion } from 'framer-motion';
import { toast } from 'react-hot-toast';

interface ReferralCardProps {
  user: User | null;
}

export const ReferralCard: React.FC<ReferralCardProps> = ({ user }) => {
  const [copied, setCopied] = useState(false);

  if (!user) return null;

  const handleCopyReferralCode = async () => {
    try {
      await navigator.clipboard.writeText(user.referralCode);
      setCopied(true);
      toast.success('æ¨èç å·²å¤åˆ¶');
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      toast.error('å¤åˆ¶å¤±è´¥');
    }
  };

  const handleCopyReferralLink = async () => {
    const referralLink = `${window.location.origin}/register?ref=${user.referralCode}`;
    try {
      await navigator.clipboard.writeText(referralLink);
      toast.success('æ¨èé“¾æ¥å·²å¤åˆ¶');
    } catch (error) {
      toast.error('å¤åˆ¶å¤±è´¥');
    }
  };

  return (
    <motion.div
      className="referral-card"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      <div className="card-header">
        <div className="header-icon">ğŸ</div>
        <div className="header-text">
          <h3>æ¨èå¥½å‹</h3>
          <p>é‚€è¯·å¥½å‹æ³¨å†Œï¼ŒåŒæ–¹éƒ½è·å¾—å¥–åŠ±</p>
        </div>
      </div>

      <div className="referral-stats">
        <div className="stat-item">
          <div className="stat-number">{user.metadata?.referralCount || 0}</div>
          <div className="stat-label">æˆåŠŸæ¨è</div>
        </div>
        <div className="stat-item">
          <div className="stat-number">{user.metadata?.referralRewards || 0}</div>
          <div className="stat-label">æ¨èå¥–åŠ±</div>
        </div>
      </div>

      <div className="referral-actions">
        <div className="referral-code-section">
          <label>æ‚¨çš„æ¨èç </label>
          <div className="code-container">
            <span className="referral-code">{user.referralCode}</span>
            <button
              className={`copy-btn ${copied ? 'copied' : ''}`}
              onClick={handleCopyReferralCode}
            >
              {copied ? 'âœ…' : 'ğŸ“‹'}
            </button>
          </div>
        </div>

        <button
          className="share-link-btn"
          onClick={handleCopyReferralLink}
        >
          å¤åˆ¶æ¨èé“¾æ¥
        </button>
      </div>

      <div className="reward-info">
        <div className="reward-item">
          <span className="reward-icon">ğŸ¯</span>
          <span className="reward-text">æ¨èæˆåŠŸè·å¾— 100 ç§¯åˆ†</span>
        </div>
        <div className="reward-item">
          <span className="reward-icon">ğŸš€</span>
          <span className="reward-text">è¢«æ¨èäººè·å¾— 50 ç§¯åˆ†</span>
        </div>
      </div>
    </motion.div>
  );
};
```

#### 3.3.4 èµ„äº§æ•°æ®è·å– Hook
```typescript
// hooks/useAssetData.ts
import { useQuery } from 'react-query';
import { PublicKey } from '@solana/web3.js';
import { fetchUserAssets } from '../services/assetService';

export interface AssetData {
  sol: number;
  gccc: number;
  gccStaked: number;
  points: number;
  dailyPoints: number;
  fragments: number;
  nfts: NFTAsset[];
  totalValue: number;
}

export const useAssetData = (publicKey: PublicKey | null) => {
  return useQuery(
    ['assetData', publicKey?.toString()],
    () => publicKey ? fetchUserAssets(publicKey) : null,
    {
      enabled: !!publicKey,
      refetchInterval: 30000, // 30ç§’è‡ªåŠ¨åˆ·æ–°
      staleTime: 10000, // 10ç§’å†…æ•°æ®è§†ä¸ºæ–°é²œ
      cacheTime: 300000, // 5åˆ†é’Ÿç¼“å­˜
      retry: 3,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    }
  );
};
```

#### 3.3.3 SOL ä½™é¢å¡ç‰‡
```typescript
// components/dashboard/SOLBalance.tsx
import React from 'react';
import { formatNumber } from '../../utils/formatters';

interface SOLBalanceProps {
  balance: number;
  className?: string;
}

export const SOLBalance: React.FC<SOLBalanceProps> = ({ 
  balance, 
  className = '' 
}) => {
  const usdValue = balance * 150; // å‡è®¾ SOL ä»·æ ¼ $150

  return (
    <div className={`asset-card sol-card ${className}`}>
      <div className="card-header">
        <div className="asset-icon">
          <img src="/icons/solana.svg" alt="SOL" />
        </div>
        <div className="asset-info">
          <h3>SOL</h3>
          <p className="asset-name">Solana</p>
        </div>
      </div>
      
      <div className="card-content">
        <div className="balance-main">
          <span className="balance-value">
            {formatNumber(balance, 4)}
          </span>
          <span className="balance-symbol">SOL</span>
        </div>
        
        <div className="balance-usd">
          â‰ˆ ${formatNumber(usdValue, 2)}
        </div>
      </div>
      
      <div className="card-actions">
        <button className="action-btn secondary">
          æ¥æ”¶
        </button>
        <button className="action-btn primary">
          å‘é€
        </button>
      </div>
    </div>
  );
};
```

#### 3.3.4 GCCC Token ä½™é¢å¡ç‰‡
```typescript
// components/dashboard/GCCCBalance.tsx
import React from 'react';
import { formatNumber } from '../../utils/formatters';

interface GCCCBalanceProps {
  balance: number;
  staked: number;
  className?: string;
}

export const GCCCBalance: React.FC<GCCCBalanceProps> = ({ 
  balance, 
  staked,
  className = '' 
}) => {
  const total = balance + staked;
  const stakingRatio = total > 0 ? (staked / total) * 100 : 0;

  return (
    <div className={`asset-card gccc-card ${className}`}>
      <div className="card-header">
        <div className="asset-icon">
          <img src="/icons/gccc.svg" alt="GCCC" />
        </div>
        <div className="asset-info">
          <h3>GCCC</h3>
          <p className="asset-name">æ²»ç†ä»£å¸</p>
        </div>
      </div>
      
      <div className="card-content">
        <div className="balance-main">
          <span className="balance-value">
            {formatNumber(total, 0)}
          </span>
          <span className="balance-symbol">GCCC</span>
        </div>
        
        <div className="balance-breakdown">
          <div className="breakdown-item">
            <span className="label">å¯ç”¨:</span>
            <span className="value">{formatNumber(balance, 0)}</span>
          </div>
          <div className="breakdown-item">
            <span className="label">è´¨æŠ¼:</span>
            <span className="value">{formatNumber(staked, 0)}</span>
          </div>
        </div>
        
        {staked > 0 && (
          <div className="staking-info">
            <div className="staking-ratio">
              è´¨æŠ¼æ¯”ä¾‹: {stakingRatio.toFixed(1)}%
            </div>
            <div className="staking-rewards">
              é¢„ä¼°å¹´æ”¶ç›Š: ~8% APY
            </div>
          </div>
        )}
      </div>
      
      <div className="card-actions">
        <button className="action-btn secondary">
          è´¨æŠ¼
        </button>
        <button className="action-btn primary">
          æ²»ç†
        </button>
      </div>
    </div>
  );
};
```

#### 3.3.5 ç§¯åˆ†ä½™é¢å¡ç‰‡
```typescript
// components/dashboard/PointsBalance.tsx
import React from 'react';
import { formatNumber } from '../../utils/formatters';

interface PointsBalanceProps {
  balance: number;
  dailyEarned: number;
  className?: string;
}

export const PointsBalance: React.FC<PointsBalanceProps> = ({ 
  balance, 
  dailyEarned,
  className = '' 
}) => {
  const canDraw = Math.floor(balance / 100); // å‡è®¾100ç§¯åˆ†æŠ½å¥–ä¸€æ¬¡

  return (
    <div className={`asset-card points-card ${className}`}>
      <div className="card-header">
        <div className="asset-icon">
          <div className="points-icon">P</div>
        </div>
        <div className="asset-info">
          <h3>ç§¯åˆ†</h3>
          <p className="asset-name">Points</p>
        </div>
      </div>
      
      <div className="card-content">
        <div className="balance-main">
          <span className="balance-value">
            {formatNumber(balance, 0)}
          </span>
          <span className="balance-symbol">PTS</span>
        </div>
        
        <div className="points-info">
          <div className="daily-earned">
            <span className="label">ä»Šæ—¥è·å¾—:</span>
            <span className="value">+{dailyEarned}</span>
          </div>
          
          <div className="draw-available">
            <span className="label">å¯æŠ½å¥–:</span>
            <span className="value">{canDraw} æ¬¡</span>
          </div>
        </div>
      </div>
      
      <div className="card-actions">
        <button className="action-btn secondary">
          ç­¾åˆ°
        </button>
        <button className="action-btn primary">
          æŠ½å¥–
        </button>
      </div>
    </div>
  );
};
```

#### 3.3.6 NFT æ”¶è—å±•ç¤º
```typescript
// components/dashboard/NFTCollection.tsx
import React, { useState } from 'react';
import { NFTAsset } from '../../types/assets';

interface NFTCollectionProps {
  nfts: NFTAsset[];
  className?: string;
}

export const NFTCollection: React.FC<NFTCollectionProps> = ({ 
  nfts, 
  className = '' 
}) => {
  const [selectedLevel, setSelectedLevel] = useState<string>('all');
  
  const nftsByLevel = nfts.reduce((acc, nft) => {
    if (!acc[nft.level]) {
      acc[nft.level] = [];
    }
    acc[nft.level].push(nft);
    return acc;
  }, {} as Record<string, NFTAsset[]>);

  const filteredNFTs = selectedLevel === 'all' 
    ? nfts 
    : nftsByLevel[selectedLevel] || [];

  const levelStats = {
    gold: nftsByLevel.Gold?.length || 0,
    silver: nftsByLevel.Silver?.length || 0,
    bronze: nftsByLevel.Bronze?.length || 0,
    iron: nftsByLevel.Iron?.length || 0,
  };

  return (
    <div className={`nft-collection ${className}`}>
      <div className="collection-header">
        <h3>çºªå¿µå¸æ”¶è—</h3>
        <div className="collection-stats">
          <span>æ€»è®¡: {nfts.length} æš</span>
        </div>
      </div>
      
      {/* ç­‰çº§ç­›é€‰ */}
      <div className="level-filters">
        <button 
          className={selectedLevel === 'all' ? 'active' : ''}
          onClick={() => setSelectedLevel('all')}
        >
          å…¨éƒ¨ ({nfts.length})
        </button>
        <button 
          className={selectedLevel === 'Gold' ? 'active' : ''}
          onClick={() => setSelectedLevel('Gold')}
        >
          é‡‘å¸ ({levelStats.gold})
        </button>
        <button 
          className={selectedLevel === 'Silver' ? 'active' : ''}
          onClick={() => setSelectedLevel('Silver')}
        >
          é“¶å¸ ({levelStats.silver})
        </button>
        <button 
          className={selectedLevel === 'Bronze' ? 'active' : ''}
          onClick={() => setSelectedLevel('Bronze')}
        >
          é“œå¸ ({levelStats.bronze})
        </button>
        <button 
          className={selectedLevel === 'Iron' ? 'active' : ''}
          onClick={() => setSelectedLevel('Iron')}
        >
          é»‘é“å¸ ({levelStats.iron})
        </button>
      </div>

      {/* NFT ç½‘æ ¼ */}
      <div className="nft-grid">
        {filteredNFTs.map((nft) => (
          <div key={nft.mint} className={`nft-item level-${nft.level.toLowerCase()}`}>
            <div className="nft-image">
              <img src={nft.image} alt={nft.name} />
              <div className="nft-level-badge">
                {nft.level}
              </div>
            </div>
            
            <div className="nft-info">
              <h4 className="nft-name">{nft.name}</h4>
              <p className="nft-event">{nft.eventName}</p>
              <div className="nft-value">
                é¢å€¼: {nft.faceValue} SOL
              </div>
            </div>
            
            <div className="nft-actions">
              <button className="action-btn view-btn">
                æŸ¥çœ‹
              </button>
              {nft.faceValue > 0 && (
                <button className="action-btn redeem-btn">
                  å›æ”¶
                </button>
              )}
            </div>
          </div>
        ))}
      </div>
      
      {filteredNFTs.length === 0 && (
        <div className="empty-collection">
          <div className="empty-icon">ğŸ¯</div>
          <h4>æš‚æ— æ”¶è—</h4>
          <p>å‚ä¸æŠ½å¥–æˆ–åˆæˆè·å–æ‚¨çš„ç¬¬ä¸€æšçºªå¿µå¸</p>
          <button className="action-btn primary">
            ç«‹å³æŠ½å¥–
          </button>
        </div>
      )}
    </div>
  );
};
```

## 4. æ•°æ®æœåŠ¡

### 4.1 èµ„äº§æœåŠ¡æ¥å£
```typescript
// services/assetService.ts
import { Connection, PublicKey, LAMPORTS_PER_SOL } from '@solana/web3.js';
import { getAccount, getMint } from '@solana/spl-token';
import { Metaplex } from '@metaplex-foundation/js';
import axios from 'axios';

export const fetchUserAssets = async (publicKey: PublicKey): Promise<AssetData> => {
  const connection = new Connection(process.env.NEXT_PUBLIC_SOLANA_RPC_ENDPOINT);
  const metaplex = new Metaplex(connection);

  // å¹¶è¡Œè·å–å„ç§èµ„äº§æ•°æ®
  const [
    solBalance,
    gccTokens,
    pointsData,
    fragmentTokens,
    nftAssets
  ] = await Promise.all([
    fetchSOLBalance(connection, publicKey),
    fetchGCCCTokens(connection, publicKey),
    fetchPointsData(publicKey),
    fetchFragmentTokens(connection, publicKey),
    fetchNFTAssets(metaplex, publicKey)
  ]);

  return {
    sol: solBalance,
    gccc: gccTokens.available,
    gccStaked: gccTokens.staked,
    points: pointsData.balance,
    dailyPoints: pointsData.dailyEarned,
    fragments: fragmentTokens,
    nfts: nftAssets,
    totalValue: calculateTotalValue({
      sol: solBalance,
      gccc: gccTokens.available + gccTokens.staked,
      nfts: nftAssets
    })
  };
};

const fetchSOLBalance = async (
  connection: Connection, 
  publicKey: PublicKey
): Promise<number> => {
  const balance = await connection.getBalance(publicKey);
  return balance / LAMPORTS_PER_SOL;
};

const fetchGCCCTokens = async (
  connection: Connection, 
  publicKey: PublicKey
): Promise<{ available: number; staked: number }> => {
  // è·å–GCCCä»£å¸ä½™é¢å’Œè´¨æŠ¼ä¿¡æ¯
  // å®ç°ç»†èŠ‚...
  return { available: 0, staked: 0 };
};

const fetchPointsData = async (
  publicKey: PublicKey
): Promise<{ balance: number; dailyEarned: number }> => {
  // ä»åç«¯APIè·å–ç§¯åˆ†æ•°æ®
  const response = await axios.get(`/api/user/${publicKey.toString()}/points`);
  return response.data;
};

const fetchNFTAssets = async (
  metaplex: Metaplex, 
  publicKey: PublicKey
): Promise<NFTAsset[]> => {
  // è·å–ç”¨æˆ·æŒæœ‰çš„çºªå¿µå¸NFT
  const nfts = await metaplex.nfts().findAllByOwner({ owner: publicKey });
  
  return nfts
    .filter(nft => nft.collection?.address.toString() === GCCC_COLLECTION_ADDRESS)
    .map(nft => ({
      mint: nft.address.toString(),
      name: nft.name,
      image: nft.json?.image || '',
      level: nft.json?.attributes?.find(attr => attr.trait_type === 'level')?.value || 'Iron',
      eventName: nft.json?.attributes?.find(attr => attr.trait_type === 'event_name')?.value || '',
      faceValue: nft.json?.attributes?.find(attr => attr.trait_type === 'face_value')?.value || 0,
      issueDate: nft.json?.attributes?.find(attr => attr.trait_type === 'issue_date')?.value || ''
    }));
};
```

## 5. çŠ¶æ€ç®¡ç†

### 5.1 Context Provider
```typescript
// contexts/DashboardContext.tsx
import React, { createContext, useContext, useReducer } from 'react';

interface DashboardState {
  selectedAsset: string | null;
  viewMode: 'grid' | 'list';
  filterLevel: string;
  sortBy: string;
  refreshing: boolean;
}

interface DashboardActions {
  selectAsset: (asset: string) => void;
  setViewMode: (mode: 'grid' | 'list') => void;
  setFilter: (level: string) => void;
  setSortBy: (sort: string) => void;
  setRefreshing: (refreshing: boolean) => void;
}

const DashboardContext = createContext<{
  state: DashboardState;
  actions: DashboardActions;
} | null>(null);

export const useDashboard = () => {
  const context = useContext(DashboardContext);
  if (!context) {
    throw new Error('useDashboard must be used within DashboardProvider');
  }
  return context;
};
```

## 6. UI/UX è®¾è®¡è¦æ±‚

### 6.1 è§†è§‰è®¾è®¡
- **å¡ç‰‡å¼å¸ƒå±€**: ä½¿ç”¨å¡ç‰‡è®¾è®¡å±•ç¤ºå„ç±»èµ„äº§
- **é¢œè‰²ç³»ç»Ÿ**: ä¸åŒèµ„äº§ç±»å‹ä½¿ç”¨ä¸åŒçš„ä¸»é¢˜è‰²
- **å›¾æ ‡ç³»ç»Ÿ**: ä¸ºæ¯ç§èµ„äº§è®¾è®¡ä¸“å±å›¾æ ‡
- **æ•°æ®å¯è§†åŒ–**: ä½¿ç”¨å›¾è¡¨å±•ç¤ºèµ„äº§è¶‹åŠ¿

### 6.2 å“åº”å¼è®¾è®¡
```css
/* å“åº”å¼ç½‘æ ¼å¸ƒå±€ */
.asset-grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

@media (max-width: 768px) {
  .asset-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
}

@media (max-width: 480px) {
  .asset-card {
    padding: 1rem;
  }
  
  .balance-value {
    font-size: 1.5rem;
  }
}
```

### 6.3 äº¤äº’è®¾è®¡
- **åŠ è½½çŠ¶æ€**: ä¼˜é›…çš„éª¨æ¶å±å’ŒåŠ è½½åŠ¨ç”»
- **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
- **å®æ—¶æ›´æ–°**: è‡ªåŠ¨åˆ·æ–°å’Œæ‰‹åŠ¨åˆ·æ–°ç»“åˆ
- **å¿«é€Ÿæ“ä½œ**: å¸¸ç”¨æ“ä½œä¸€é”®ç›´è¾¾

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æ•°æ®ç¼“å­˜
```typescript
// ä½¿ç”¨ React Query ç¼“å­˜ç­–ç•¥
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 30000, // 30ç§’
      cacheTime: 300000, // 5åˆ†é’Ÿ
      refetchOnWindowFocus: false,
      retry: 3,
    },
  },
});
```

### 7.2 è™šæ‹ŸåŒ–æ»šåŠ¨
```typescript
// å¯¹äºå¤§é‡NFTçš„è™šæ‹ŸåŒ–å¤„ç†
import { FixedSizeGrid as Grid } from 'react-window';

const VirtualizedNFTGrid: React.FC<{ nfts: NFTAsset[] }> = ({ nfts }) => {
  const itemsPerRow = 4;
  const rowCount = Math.ceil(nfts.length / itemsPerRow);
  
  return (
    <Grid
      columnCount={itemsPerRow}
      rowCount={rowCount}
      columnWidth={250}
      rowHeight={300}
      height={600}
      width="100%"
    >
      {({ columnIndex, rowIndex, style }) => (
        <div style={style}>
          <NFTCard nft={nfts[rowIndex * itemsPerRow + columnIndex]} />
        </div>
      )}
    </Grid>
  );
};
```

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•
```typescript
// __tests__/UserDashboard.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from 'react-query';
import { UserDashboard } from '../UserDashboard';

describe('UserDashboard', () => {
  let queryClient: QueryClient;

  beforeEach(() => {
    queryClient = new QueryClient({
      defaultOptions: {
        queries: { retry: false },
      },
    });
  });

  test('æ˜¾ç¤ºèµ„äº§å¡ç‰‡', async () => {
    const mockAssetData = {
      sol: 10.5,
      gccc: 1000,
      points: 500,
      // ...
    };

    render(
      <QueryClientProvider client={queryClient}>
        <UserDashboard />
      </QueryClientProvider>
    );

    await waitFor(() => {
      expect(screen.getByText('10.5000 SOL')).toBeInTheDocument();
      expect(screen.getByText('1,000 GCCC')).toBeInTheDocument();
    });
  });
});
```

## 9. å®‰å…¨è€ƒè™‘

### 9.1 æ•°æ®éªŒè¯
- **ä½™é¢éªŒè¯**: æ‰€æœ‰ä½™é¢æ•°æ®éƒ½è¦è¿›è¡Œæ ¼å¼éªŒè¯
- **NFT éªŒè¯**: éªŒè¯ NFT çš„çœŸå®æ€§å’Œå½’å±
- **äº¤æ˜“éªŒè¯**: éªŒè¯äº¤æ˜“ç­¾åå’ŒçŠ¶æ€

### 9.2 éšç§ä¿æŠ¤
- **æ•æ„Ÿæ•°æ®**: ä¸åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- **API è°ƒç”¨**: ä½¿ç”¨å®‰å…¨çš„ API ç«¯ç‚¹
- **ç”¨æˆ·éšç§**: ä¿æŠ¤ç”¨æˆ·çš„äº¤æ˜“å†å²éšç§

## 10. éƒ¨ç½²å’Œç»´æŠ¤

### 10.1 ç›‘æ§æŒ‡æ ‡
- **åŠ è½½æ€§èƒ½**: ç›‘æ§å„èµ„äº§æ•°æ®çš„åŠ è½½æ—¶é—´
- **é”™è¯¯ç‡**: ç›‘æ§APIè°ƒç”¨å’Œæ•°æ®è·å–çš„é”™è¯¯ç‡
- **ç”¨æˆ·è¡Œä¸º**: è·Ÿè¸ªç”¨æˆ·åœ¨ä»ªè¡¨ç›˜çš„æ“ä½œè¡Œä¸º

### 10.2 ç»´æŠ¤ç­–ç•¥
- **å®šæœŸæ›´æ–°**: å®šæœŸæ›´æ–°èµ„äº§ä»·æ ¼å’Œæ±‡ç‡
- **æ•°æ®åŒæ­¥**: ç¡®ä¿é“¾ä¸Šé“¾ä¸‹æ•°æ®çš„ä¸€è‡´æ€§
- **åŠŸèƒ½è¿­ä»£**: æ ¹æ®ç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ–ç•Œé¢
