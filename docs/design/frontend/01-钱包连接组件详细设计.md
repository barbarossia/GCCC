# 钱包连接组件详细设计文档

## 1. 模块概述

钱包连接组件是整个 DApp 的入口组件，负责用户身份认证和区块链交互的基础设施。该组件支持主流 Solana 钱包，包括 Phantom、Solflare、Backpack 等。

## 2. 功能需求

### 2.1 核心功能
- **钱包检测**: 自动检测用户浏览器中已安装的 Solana 钱包
- **钱包连接**: 支持用户选择并连接钱包
- **钱包切换**: 允许用户在多个钱包间切换
- **自动重连**: 页面刷新后自动重新连接之前的钱包
- **连接状态管理**: 实时监控钱包连接状态
- **错误处理**: 处理各种连接异常情况

### 2.2 支持的钱包
- **Phantom**: 主推钱包，用户基数最大
- **Solflare**: 功能丰富的钱包选择
- **Backpack**: 新兴钱包，用户体验优秀
- **Slope**: 移动端友好
- **Coin98**: 多链钱包支持

## 3. 技术实现

### 3.1 技术栈
```javascript
// 主要依赖
{
  "@solana/wallet-adapter-react": "^0.15.35",
  "@solana/wallet-adapter-react-ui": "^0.9.35",
  "@solana/wallet-adapter-wallets": "^0.19.32",
  "@solana/web3.js": "^1.95.2"
}
```

### 3.2 组件架构
```
WalletConnectionProvider
├── WalletAdapter (Context Provider)
├── WalletModal (连接选择界面)
├── WalletButton (连接/断开按钮)
├── WalletInfo (用户信息显示)
└── WalletErrorHandler (错误处理)
```

### 3.3 核心代码结构

#### 3.3.1 WalletProvider 配置
```typescript
// providers/WalletProvider.tsx
import { 
  ConnectionProvider, 
  WalletProvider as SolanaWalletProvider 
} from '@solana/wallet-adapter-react';
import { WalletModalProvider } from '@solana/wallet-adapter-react-ui';
import {
  PhantomWalletAdapter,
  SolflareWalletAdapter,
  BackpackWalletAdapter,
  SlopeWalletAdapter,
  Coin98WalletAdapter,
} from '@solana/wallet-adapter-wallets';

const SOLANA_RPC_ENDPOINT = process.env.NEXT_PUBLIC_SOLANA_RPC_ENDPOINT;

const wallets = [
  new PhantomWalletAdapter(),
  new SolflareWalletAdapter(),
  new BackpackWalletAdapter(),
  new SlopeWalletAdapter(),
  new Coin98WalletAdapter(),
];

export const WalletProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return (
    <ConnectionProvider endpoint={SOLANA_RPC_ENDPOINT}>
      <SolanaWalletProvider wallets={wallets} autoConnect>
        <WalletModalProvider>
          {children}
        </WalletModalProvider>
      </SolanaWalletProvider>
    </ConnectionProvider>
  );
};
```

#### 3.3.2 钱包连接按钮组件
```typescript
// components/wallet/WalletConnectButton.tsx
import { useWallet } from '@solana/wallet-adapter-react';
import { WalletMultiButton } from '@solana/wallet-adapter-react-ui';

export const WalletConnectButton: React.FC = () => {
  const { wallet, connected, connecting, disconnecting } = useWallet();

  return (
    <div className="wallet-connect-container">
      <WalletMultiButton 
        className="wallet-connect-btn"
        startIcon={
          <svg width="20" height="20" viewBox="0 0 20 20">
            {/* 钱包图标 */}
          </svg>
        }
      />
      
      {/* 连接状态指示器 */}
      {connecting && (
        <div className="connecting-indicator">
          <div className="spinner" />
          <span>连接中...</span>
        </div>
      )}
      
      {disconnecting && (
        <div className="disconnecting-indicator">
          <span>断开连接中...</span>
        </div>
      )}
    </div>
  );
};
```

#### 3.3.3 钱包信息显示组件
```typescript
// components/wallet/WalletInfo.tsx
import { useWallet, useConnection } from '@solana/wallet-adapter-react';
import { useEffect, useState } from 'react';
import { LAMPORTS_PER_SOL } from '@solana/web3.js';

export const WalletInfo: React.FC = () => {
  const { publicKey, connected } = useWallet();
  const { connection } = useConnection();
  const [balance, setBalance] = useState<number>(0);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (connected && publicKey) {
      fetchBalance();
    }
  }, [connected, publicKey]);

  const fetchBalance = async () => {
    if (!publicKey) return;
    
    setLoading(true);
    try {
      const balance = await connection.getBalance(publicKey);
      setBalance(balance / LAMPORTS_PER_SOL);
    } catch (error) {
      console.error('获取余额失败:', error);
    } finally {
      setLoading(false);
    }
  };

  if (!connected || !publicKey) {
    return null;
  }

  return (
    <div className="wallet-info">
      <div className="wallet-address">
        <span className="label">钱包地址:</span>
        <span className="address">
          {publicKey.toString().slice(0, 4)}...{publicKey.toString().slice(-4)}
        </span>
        <button 
          onClick={() => navigator.clipboard.writeText(publicKey.toString())}
          className="copy-btn"
        >
          复制
        </button>
      </div>
      
      <div className="wallet-balance">
        <span className="label">SOL 余额:</span>
        {loading ? (
          <div className="balance-loading">加载中...</div>
        ) : (
          <span className="balance">{balance.toFixed(4)} SOL</span>
        )}
        <button onClick={fetchBalance} className="refresh-btn">
          刷新
        </button>
      </div>
    </div>
  );
};
```

## 4. 状态管理

### 4.1 钱包状态接口
```typescript
// types/wallet.ts
export interface WalletState {
  connected: boolean;
  connecting: boolean;
  disconnecting: boolean;
  publicKey: string | null;
  balance: number;
  walletName: string | null;
  error: string | null;
}

export interface WalletActions {
  connect: () => Promise<void>;
  disconnect: () => Promise<void>;
  refreshBalance: () => Promise<void>;
  clearError: () => void;
}
```

### 4.2 自定义 Hook
```typescript
// hooks/useWalletState.ts
import { useWallet, useConnection } from '@solana/wallet-adapter-react';
import { useState, useEffect, useCallback } from 'react';

export const useWalletState = () => {
  const { publicKey, connected, connecting, disconnecting, wallet } = useWallet();
  const { connection } = useConnection();
  const [balance, setBalance] = useState<number>(0);
  const [error, setError] = useState<string | null>(null);

  const refreshBalance = useCallback(async () => {
    if (!publicKey) return;
    
    try {
      const balance = await connection.getBalance(publicKey);
      setBalance(balance / LAMPORTS_PER_SOL);
      setError(null);
    } catch (err) {
      setError('获取余额失败');
      console.error(err);
    }
  }, [publicKey, connection]);

  useEffect(() => {
    if (connected && publicKey) {
      refreshBalance();
    } else {
      setBalance(0);
    }
  }, [connected, publicKey, refreshBalance]);

  return {
    connected,
    connecting,
    disconnecting,
    publicKey: publicKey?.toString() || null,
    balance,
    walletName: wallet?.adapter.name || null,
    error,
    refreshBalance,
    clearError: () => setError(null),
  };
};
```

## 5. 错误处理

### 5.1 常见错误类型
- **WalletNotFoundError**: 未找到钱包
- **WalletConnectionError**: 连接失败
- **WalletDisconnectedError**: 钱包断开连接
- **WalletSignTransactionError**: 签名失败

### 5.2 错误处理组件
```typescript
// components/wallet/WalletErrorHandler.tsx
import { useWallet } from '@solana/wallet-adapter-react';
import { useEffect } from 'react';
import { toast } from 'react-toastify';

export const WalletErrorHandler: React.FC = () => {
  const { wallet } = useWallet();

  useEffect(() => {
    if (wallet) {
      wallet.adapter.on('error', (error) => {
        console.error('钱包错误:', error);
        
        switch (error.name) {
          case 'WalletNotFoundError':
            toast.error('未找到钱包，请安装相应的钱包扩展');
            break;
          case 'WalletConnectionError':
            toast.error('钱包连接失败，请重试');
            break;
          case 'WalletDisconnectedError':
            toast.error('钱包连接已断开');
            break;
          default:
            toast.error('钱包操作失败，请重试');
        }
      });
    }
  }, [wallet]);

  return null;
};
```

## 6. UI/UX 设计要求

### 6.1 视觉设计
- **连接按钮**: 醒目的主色调，圆角设计，包含钱包图标
- **连接状态**: 清晰的视觉反馈，加载动画
- **钱包信息**: 简洁的信息展示，易于读取
- **错误提示**: 明确的错误信息，引导用户解决问题

### 6.2 交互设计
- **一键连接**: 简化连接流程，减少用户操作步骤
- **自动检测**: 智能推荐用户已安装的钱包
- **快速切换**: 支持在多个钱包间快速切换
- **状态保持**: 页面刷新后保持连接状态

### 6.3 响应式设计
- **桌面端**: 完整功能展示
- **移动端**: 简化界面，突出核心功能
- **平板端**: 适配中等屏幕尺寸

## 7. 安全考虑

### 7.1 数据安全
- **私钥安全**: 绝不存储或传输用户私钥
- **签名验证**: 所有交易都需要用户确认
- **权限最小化**: 只请求必要的钱包权限

### 7.2 网络安全
- **RPC 端点**: 使用可信的 Solana RPC 端点
- **SSL 加密**: 所有网络通信使用 HTTPS
- **跨域防护**: 配置适当的 CORS 策略

## 8. 测试策略

### 8.1 单元测试
```typescript
// __tests__/WalletConnectButton.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { WalletConnectButton } from '../components/wallet/WalletConnectButton';

describe('WalletConnectButton', () => {
  test('显示连接按钮', () => {
    render(<WalletConnectButton />);
    expect(screen.getByText('连接钱包')).toBeInTheDocument();
  });

  test('点击后触发连接', () => {
    const mockConnect = jest.fn();
    render(<WalletConnectButton onConnect={mockConnect} />);
    
    fireEvent.click(screen.getByText('连接钱包'));
    expect(mockConnect).toHaveBeenCalled();
  });
});
```

### 8.2 集成测试
- **钱包连接流程**: 测试完整的连接和断开流程
- **错误处理**: 测试各种错误场景的处理
- **状态同步**: 测试钱包状态的同步更新

## 9. 性能优化

### 9.1 代码分割
```typescript
// 懒加载钱包适配器
const PhantomAdapter = lazy(() => import('@solana/wallet-adapter-phantom'));
const SolflareAdapter = lazy(() => import('@solana/wallet-adapter-solflare'));
```

### 9.2 缓存策略
- **连接状态缓存**: 在 localStorage 中缓存连接偏好
- **余额缓存**: 适当缓存余额信息，减少 RPC 调用

## 10. 部署配置

### 10.1 环境变量
```env
# .env.local
NEXT_PUBLIC_SOLANA_RPC_ENDPOINT=https://api.mainnet-beta.solana.com
NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta
```

### 10.2 构建配置
```javascript
// next.config.js
module.exports = {
  webpack: (config) => {
    config.resolve.fallback = {
      fs: false,
      path: false,
    };
    return config;
  },
};
```
