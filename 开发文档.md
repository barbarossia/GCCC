# 全球共识纪念币 (Global Consensus) 开发文档

## 1. 文档目的
本文档旨在为“全球共识纪念币”项目的技术开发团队提供全面的技术指引，包括系统架构、技术选型、模块设计和关键实现细节，以确保项目顺利、高效地开发与部署。

## 2. 系统架构
项目采用典型的 Web3 DApp 架构，分为前端、后端和区块链三层。

-   **前端 (Frontend):** 用户交互界面，负责展示数据、连接钱包，并发起交易请求。
-   **后端 (Backend):** 处理非区块链核心的业务逻辑，如用户数据管理、定时任务、提供 API 服务等。
-   **区块链 (Blockchain):** 核心资产和规则的所在地，通过智能合约保证系统的去中心化、透明和安全。

### 技术选型建议
-   **区块链平台:** **Solana** (基于需求文档中 SOL 的提及，其高性能和低交易费用适合此类应用)。
-   **前端框架:** **React / Next.js** 或 **Vue / Nuxt.js** (主流框架，生态成熟)。
-   **后端框架:** **Node.js (Express / NestJS)** (与前端 JavaScript 技术栈统一，便于开发)。
-   **数据库:** **PostgreSQL** 或 **MongoDB** (用于存储 Points、用户信息等链下数据)。
-   **智能合约语言:** **Rust** (Solana 合约开发标准)。
-   **NFT 标准:** **Metaplex** (Solana 生态系统中最成熟的 NFT 标准)。

## 3. 智能合约设计
所有核心资产和逻辑都应在链上实现。

### 3.1. GCCC Token 合约 (SPL Token)
-   **类型:** Solana Program Library (SPL) Token。
-   **名称:** GCC Token
-   **符号:** GCCC
-   **总供应量:** 1,000,000,000
-   **小数位数:** (建议 6-9 位)
-   **功能:**
    -   实现标准的 SPL Token 接口。
    -   需要编写一个归属（Vesting）合约来处理团队、投资者和基金会的代币线性解锁逻辑。

### 3.2. 纪念币合约 (NFT)
-   **类型:** Solana NFT，遵循 Metaplex 标准。
-   **集合 (Collection):** 每月发行的纪念币应属于同一个“全球共识纪念币”集合。
-   **属性 (Attributes):**
    -   `event_name`: (string) 纪念的事件名称。
    -   `issue_date`: (string) 发行日期。
    -   `level`: (string) 等级 (Gold, Silver, Bronze, Iron)。
    -   `face_value`: (number) 面值 (10, 1, 0.1, 0)。
-   **铸造权限:** 铸造权限应由治理合约控制。

### 3.3. 治理与质押合约 (Governance & Staking)
这是最核心的合约，负责处理提案和投票逻辑。
-   **数据结构:**
    -   `Proposal`: { id, description, image_url, creator, vote_count, start_time, end_time, status }
    -   `StakeRecord`: { user_wallet, amount, start_time }
-   **功能:**
    -   `submit_proposal()`: 用户提交提案。
    -   `stake()`: 用户质押 GCCC Token 到合约中。
    -   `unstake()`: 用户赎回质押的 Token（投票期结束后）。
    -   `vote()`: 用户对提案进行投票，票权根据其质押量计算。
    -   `tally_votes()`: 在投票期结束后，计算并宣布获胜提案。
    -   `execute_proposal()`: 触发纪念币合约，根据获胜提案铸造 NFT。

### 3.4. 抽奖与合成合约 (Raffle & Synthesis)
-   **抽奖 (Raffle):**
    -   **随机数:** 链上随机数是关键。需要集成 **Chainlink VRF** 或 **Pyth Network** 等预言机服务来获取安全的、不可预测的随机数。
    -   `request_randomness()`: 用户发起抽奖请求。
    -   `fulfill_randomness()`: 预言机回调函数，根据返回的随机数确定奖品等级，并直接向用户钱包空投纪念币 NFT 或碎片（SPL Token）。
-   **合成 (Synthesis):**
    -   `synthesize()`: 用户调用此函数，合约检查其钱包中的碎片 Token 数量，如果满足条件，则销毁（burn）相应数量的碎片，并铸造（mint）一枚对应等级的纪念币 NFT 给用户。

### 3.5. 回收合约 (Redemption)
-   **功能:**
    -   `redeem_coin()`: 用户将金/银/铜币发送到此合约。
    -   合约验证 NFT 的真实性后，销毁该 NFT，并从合约金库中将对应面值的 SOL 转账给用户。
-   **资金池:** 需要一个由团队注资的 SOL 金库来支持回收。

## 4. 后端服务 (Off-Chain)

### 4.1. API 服务
-   `/user/profile`: 获取用户信息，包括钱包地址、Points 数量。
-   `/proposals`: 获取当前和历史提案列表。
-   `/leaderboard`: （可选）排行榜功能。

### 4.2. 用户与 Points 系统
-   **数据库表:**
    -   `users`: { `wallet_address` (PK), `points` (integer), `last_signin_date` (date) }
-   **签到逻辑:**
    -   用户通过前端发起签到请求。
    -   后端验证 `last_signin_date`，确保每天只能签到一次。
    -   后端调用 Solana RPC，使用 `getBalance` 检查用户钱包的 SOL 余额，根据防刷规则计算应得的 Points。
    -   更新数据库中的 `points` 和 `last_signin_date`。

### 4.3. 定时任务 (Cron Jobs)
-   **每月1日 00:00:** 开启新一轮提案周期。
-   **每月11日 00:00:** 结束提案，开启投票周期。
-   **每月20日 00:00:** 结束投票，自动调用治理合约的 `tally_votes()` 函数。

## 5. 前端模块

1.  **钱包连接组件:** 支持 Phantom, Solflare 等主流 Solana 钱包。
2.  **用户仪表盘:** 展示用户持有的 SOL, GCCC, Points, 纪念币和碎片。
3.  **提案模块:** 展示提案列表，提供提交新提案的表单。
4.  **投票模块:** 提案详情页，展示投票按钮和实时票数。
5.  **质押/赎回模块:** 提供质押和赎回 GCCC Token 的交互界面。
6.  **抽奖模块:** "一键抽奖" 按钮，展示抽奖动画和结果。
7.  **合成模块:** 展示合成规则，提供合成操作界面。

## 6. 关键技术挑战与解决方案

-   **防刷与机器人:**
    -   **方案:** 后端在处理签到请求时，实时查询用户钱包的 SOL 余额。这是核心防线。
    -   **补充:** 前端可加入 reCAPTCHA 等人机验证机制。
-   **安全:**
    -   **合约审计:** 所有智能合约在上线前必须经过至少一家专业安全公司的审计。
    -   **权限控制:** 严格控制合约的 owner/admin 权限，特别是铸币和资金提取权限。
    -   **防范闪电贷:** 投票权重应基于质押一段时间的 Token 数量，而不是投票瞬间的快照，以防范闪电贷攻击。
-   **数据一致性:**
    -   确保链上状态（如 Token 余额）和链下数据（如 Points）的同步。后端服务应在关键操作后重新查询链上数据以进行校准。
