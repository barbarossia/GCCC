# GCCC 后端快速开始指南

## 环境要求

- Node.js 18+ 
- PostgreSQL 13+
- Redis 6+
- Git

## 快速安装

### 1. 克隆项目

```bash
git clone <repository-url>
cd GCCC/src/backend
```

### 2. 安装依赖

```bash
npm install
```

### 3. 环境配置

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
notepad .env
```

### 4. 数据库设置

```bash
# 创建数据库
createdb gccc_db

# 运行数据库迁移
npm run migrate

# 初始化数据种子
npm run seed
```

### 5. 启动服务

```bash
# 开发模式
npm run dev

# 生产模式
npm start
```

## 环境变量配置

创建 `.env` 文件并配置以下变量：

```env
# 服务器配置
NODE_ENV=development
PORT=3000
HOST=localhost

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=gccc_db
DB_USER=postgres
DB_PASSWORD=your_password
DB_SSL=false

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT配置
JWT_SECRET=your_super_secret_jwt_key_here
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# Solana配置
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_NETWORK=devnet
GCCC_TOKEN_MINT=your_token_mint_address_here
STAKING_PROGRAM_ID=your_staking_program_id_here

# API配置
API_VERSION=v1
API_PREFIX=/api
CORS_ORIGIN=http://localhost:3000,http://localhost:3001

# 安全配置
BCRYPT_ROUNDS=12
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# 邮件配置（可选）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password
EMAIL_FROM=noreply@gccc.com

# IPFS配置（可选）
IPFS_GATEWAY=https://ipfs.io/ipfs/
PINATA_API_KEY=your_pinata_api_key
PINATA_SECRET_KEY=your_pinata_secret_key

# 日志配置
LOG_LEVEL=info
LOG_FILE=logs/app.log
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# 监控配置（可选）
SENTRY_DSN=your_sentry_dsn_here
HEALTH_CHECK_PATH=/health
```

## 项目脚本

### 开发相关

```bash
# 开发模式启动（带热重载）
npm run dev

# 生产模式启动
npm start

# 代码格式化
npm run format

# 代码检查
npm run lint

# 修复代码问题
npm run lint:fix
```

### 数据库相关

```bash
# 运行数据库迁移
npm run migrate

# 回滚迁移
npm run migrate:rollback

# 初始化数据种子
npm run seed

# 重置数据库
npm run db:reset

# 生成迁移文件
npm run migrate:make <migration_name>
```

### 测试相关

```bash
# 运行所有测试
npm test

# 运行单元测试
npm run test:unit

# 运行集成测试
npm run test:integration

# 测试覆盖率
npm run test:coverage

# 监视模式测试
npm run test:watch
```

### 部署相关

```bash
# 构建生产版本
npm run build

# 使用PM2部署
npm run deploy

# 检查PM2状态
npm run pm2:status

# 查看PM2日志
npm run pm2:logs

# 重启PM2进程
npm run pm2:restart
```

## API测试

### 健康检查

```bash
curl http://localhost:3000/health
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-01T00:00:00.000Z",
    "uptime": 3600,
    "version": "1.0.0",
    "environment": "development",
    "database": "connected",
    "redis": "connected"
  },
  "message": "Service is healthy"
}
```

### 用户注册

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "5oNDL3swdJJF1g9DzJiZ4ynHXgszjAEpXzvhTVNhD9dT",
    "signature": "signature_string_here",
    "message": "Please sign this message to verify your wallet",
    "nonce": "random_nonce_string",
    "username": "testuser",
    "email": "test@example.com"
  }'
```

### 用户登录

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "5oNDL3swdJJF1g9DzJiZ4ynHXgszjAEpXzvhTVNhD9dT",
    "signature": "signature_string_here",
    "message": "Please sign this message to authenticate",
    "nonce": "random_nonce_string"
  }'
```

### 获取用户信息

```bash
curl -X GET http://localhost:3000/api/user/profile \
  -H "Authorization: Bearer your_jwt_token_here"
```

## 目录结构详解

### API路由层 (`/api`)

每个功能模块包含三个文件：

- **`.routes.js`**: 定义HTTP路由和中间件
- **`.controller.js`**: 处理请求逻辑和响应
- **`.validation.js`**: 输入参数验证规则

**示例结构**:
```
api/
├── auth/
│   ├── auth.routes.js      # POST /auth/register, /auth/login
│   ├── auth.controller.js  # registerUser, loginUser
│   └── auth.validation.js  # validateRegister, validateLogin
```

### 中间件层 (`/middleware`)

提供横切关注点的处理：

- **`auth.middleware.js`**: JWT认证验证
- **`permission.middleware.js`**: 基于角色的权限控制
- **`validation.middleware.js`**: 请求参数验证
- **`rateLimit.middleware.js`**: API调用频率限制
- **`error.middleware.js`**: 统一错误处理

### 服务层 (`/services`)

封装业务逻辑和外部依赖：

- **`database/`**: 数据库操作服务
- **`blockchain/`**: Solana区块链交互
- **`external/`**: 第三方服务集成
- **`cache/`**: 缓存管理服务

### 工具函数 (`/utils`)

提供通用辅助功能：

- **`crypto.js`**: 加密解密工具
- **`validation.js`**: 数据验证工具
- **`response.js`**: API响应格式化
- **`logger.js`**: 日志记录工具

## 开发规范

### 1. 代码风格

- 使用ESLint + Prettier进行代码格式化
- 遵循JavaScript Standard Style
- 使用驼峰命名法（camelCase）
- 文件名使用小写+点分隔（auth.controller.js）

### 2. 提交规范

```bash
# 功能添加
git commit -m "feat: add user registration API"

# 错误修复
git commit -m "fix: resolve JWT token validation issue"

# 文档更新
git commit -m "docs: update API documentation"

# 代码重构
git commit -m "refactor: optimize database query performance"
```

### 3. 分支管理

- `main`: 生产分支
- `develop`: 开发分支
- `feature/*`: 功能分支
- `hotfix/*`: 热修复分支

### 4. 测试要求

- 单元测试覆盖率 > 80%
- 集成测试覆盖核心API
- 所有API都需要有对应的测试用例

## 常见问题

### 1. 数据库连接失败

**问题**: `Error: connect ECONNREFUSED 127.0.0.1:5432`

**解决方案**:
```bash
# 检查PostgreSQL是否运行
pg_ctl status

# 启动PostgreSQL服务
pg_ctl start

# 检查连接配置
psql -h localhost -p 5432 -U postgres -d gccc_db
```

### 2. Redis连接失败

**问题**: `Error: connect ECONNREFUSED 127.0.0.1:6379`

**解决方案**:
```bash
# 启动Redis服务
redis-server

# 检查Redis状态
redis-cli ping
```

### 3. JWT Token验证失败

**问题**: `Error: JsonWebTokenError: invalid signature`

**解决方案**:
- 检查JWT_SECRET环境变量是否正确设置
- 确保客户端和服务器使用相同的密钥
- 验证token格式是否正确（Bearer token）

### 4. Solana网络连接问题

**问题**: `Error: Network request failed`

**解决方案**:
- 检查SOLANA_RPC_URL配置
- 验证网络连接状态
- 确认Solana网络状态正常

## 部署指南

### 1. 开发环境

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
```

### 2. 生产环境

```bash
# 使用PM2部署
npm install pm2 -g
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save

# 监控服务
pm2 monit
```

### 3. Docker部署

```bash
# 构建镜像
docker build -t gccc-backend .

# 运行容器
docker run -d \
  --name gccc-backend \
  -p 3000:3000 \
  --env-file .env \
  gccc-backend

# 查看日志
docker logs -f gccc-backend
```

## 监控和维护

### 1. 日志管理

日志文件位置：`logs/app.log`

```bash
# 查看实时日志
tail -f logs/app.log

# 搜索错误日志
grep "ERROR" logs/app.log

# 日志轮转配置在utils/logger.js中
```

### 2. 性能监控

```bash
# 检查进程状态
pm2 list

# 查看资源使用
pm2 monit

# 生成性能报告
npm run perf:report
```

### 3. 健康检查

```bash
# API健康检查
curl http://localhost:3000/health

# 数据库健康检查
npm run health:db

# Redis健康检查
npm run health:redis
```

## 文档和资源

- [完整API文档](./docs/API_Documentation.md)
- [数据库设计文档](../../database/)
- [前端接口对接指南](../frontend/docs/)
- [部署运维手册](./docs/deployment.md)

## 支持和反馈

如果遇到问题或有改进建议，请：

1. 查看[常见问题](#常见问题)部分
2. 搜索已有的Issue
3. 创建新的Issue并详细描述问题
4. 联系开发团队

---

*最后更新: 2024年1月*
